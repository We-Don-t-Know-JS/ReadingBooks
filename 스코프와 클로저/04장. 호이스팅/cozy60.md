# 호이스팅

## 닭이 먼저냐 달걀이 먼저냐

자바스크립트 프로그램이 실행되면 코드가 한 줄 한 줄 위에서부터 차례대로 해석될 것이라고 생각하기 쉽다. 그러나 `var a`선언이 `a=2`뒤에 있어도 결과값은 제대로 나타난다.

## 컴파일러는 두 번 공격한다

자바스크립트 엔진이 코드를 인터프리팅하기 전에 컴파일한다는 사실을 기억해보자. 컴파일레이션 단계 중에는 모든 선언문을 찾아 적절한 스코프에 연결해주는 과저잉 있었다. 바로 이 과정이 렉시컬 스코프의 핵심이다.

변수와 함수 선언문 모두 코드가 실행되기 전에 먼저 처리된다고 보면 된다. 예를 들어 `var a =2;`를 하나의 구문처럼 생각할 수 있지만, 자바스크립트는 다음 두 개의 구문으로 본다.

- var a;
- a = 2;

첫째 구문은 선언문으로 컴파일레이션 단계에서 처리된다.
둘째 구문은 대입문으로 실행 단계까지 내버려둔다.

이 과정을 비유적으로 말하면 번수와 함수 선언문은 선언된 위치에서 코드의 꼭대기로 '끌어올려'진다. 이렇게 선언문을 끌어올리는 동작을 `호이스팅`이라고 한다. 즉, 선언문이 대입문보다 먼저다. 선언문만 끌어올려지고 다른 대입문이나 실행 로직 부분은 제자리에 그대로 된다.

```js
foo();

function foo() {
  console.log(a); // undefined
  var a = 2;
}
```

함수 foo의 선언문은 끌어올려졌으므로 foo를 첫째 줄에서도 호출할 수 있다.
호이스팅이 스코프별로 작동한다는 점도 중요하다. 예제 함수 foo() 내에서도 변수 a가 프로그램의 꼭대기가 아니라 foo()의 꼭대기로 끌어올려진다. 위의 코드를 좀 더 정확히 해석하면 다음과 같다.

```js
function foo() {
  var a;
  console.log(a); // undefined
  a = 2;
}

foo();
```

함수 선언문은 이와 같이 끌어올려지지만 함수 표현식은 다르다.

```js
foo();

var foo = function bar() {
  // ...
};
```

변수 확인자 foo는 끌어올려져 둘러싼 글로벌 스코프에 붙으므로 foo() 호출은 실패하지 않고, ReferenceError도 발생하지 않는다. 그러나 foo는 아직 값을 가지고 있지 않는데 (함수가 아니라 선언문으로 생성된 것 처럼), foo()가 호출하려 해서 오작동을 발생시킨다.

함수 표현식이 이름을 가져도 그 이름 확인자는 해당 스코프에서 찾을 수 없다. ReferenceError가 나타나게 된다.

## 함수가 먼저다

함수와 변수 선언문은 모두 끌어올려진다. 그러나 미묘한 차이가 있는데, **먼저 함수가 끌어올려지고 그 다음으로 변수가 올려진다.**

```js
foo(); // 1
var foo;

function foo() {
  console.log(1);
}

foo = function () {
  console.log(2);
};
```

엔진은 이 코드를 다음과 같이 해석한다.

```js
function foo() {
  console.log(1);
}
foo(); // 1

foo = function () {
  console.log(2);
};
```

var foo가 중복(그래서 무시된)선언문이라는 점을 보자. var foo는 function foo()선언보다 앞서있지만, 함수 선언문이 일반 변수 위로 끌어올려졌다. 많은 중복 변수 선언문이 사실상 무시됐지만 중복 함수 선언문은 앞선 것들을 겹쳐 쓴다.

일반 블록 안에서 보이는 함수 선언문은 보통 둘러싼 스코프로 끌어올려지지만, 특정 블록애서는 따르지 않을 수도 있다.

## 정리하기

변수 선언에서 엔진은 선언과 대입을 독립된 구문으로 보고, 선언 구문은 컴파일러 단계에서 대입 구문은 실행 단계에서 처리한다.
이것이 의미하는 바는 스코프의 모든 선언문은 어디서 나타나든 실행 전에 먼저 처리된다는 점이다. 호이스팅이라 불리는 이 과정은 변수와 함수 선언문이 각각이 속한 스코프의 꼭대기로 끌어올려지는 작업이라고 생각할 수 있다. 그 과정에서 선언문 자체는 옮겨지지만, 함수 표현식의 대입문을 포함한 모든 대입문을 끌어올려 지지 않는다.
